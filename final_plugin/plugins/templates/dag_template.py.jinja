{# dag_template.py.jinja â€“ used by generate_dags() to render the .py file #}
from datetime import datetime
from airflow import DAG
from airflow.operators.bash import BashOperator
{% if ssh_conn_id %}
from slurm_plugin.operators.slurm_operator import SubmitAndMonitorSlurmJobOperator
{% endif %}

# Default arguments
default_args = {
    'owner': '{{ workflow_owner }}',
    'depends_on_past': False,
    'start_date': datetime({{ start_date_year }}, {{ start_date_month }}, {{ start_date_day }}),
    {% if workflow_email %}
    'email': ['{{ workflow_email }}'],
    'email_on_failure': True,
    {% endif %}
}

with DAG(
    dag_id='{{ workflow_name }}',
    default_args=default_args,
    description={{ workflow_description|tojson }},
    schedule_interval={% if schedule_type == 'scheduled' %}'{{ schedule_interval }}'{% else %}None{% endif %},
    catchup={{ 'True' if catchup else 'False' }},
    tags=[{% for tag in workflow_tags.split(',') if tag.strip() %}'{{ tag.strip() }}',{% endfor %}],
) as dag:

    {% if download %}
    git_clone = BashOperator(
        task_id='git_clone',
        bash_command=(
            'git clone '
            '{% if branch_or_tag %}-b {{ branch_or_tag }} {% endif %}'
            '{{ repo_url }} {{ target_path }}'
        )
    )
    {% endif %}

    {% if transfer %}
    transfer_to_gpfs = BashOperator(
        task_id='transfer_to_gpfs',
        bash_command=(
            'aws s3 {% if only_latest %}sync --exact-timestamps --delete{% else %}sync{% endif %} '
            '{{ source_bucket }} {{ dest_path_gpfs }} '
            '{% if batch_size %}--size-only --delete --no-progress --only-show-errors --max-concurrent-requests {{ parallel_transfers }}{% endif %}'
        )
    )
    {% endif %}

    {% if ssh_conn_id %}
    slurm_submit = SubmitAndMonitorSlurmJobOperator(
        task_id='submit_slurm',
        ssh_conn_id='{{ ssh_conn_id }}',
        script_path='{{ script_path }}',
        {% if partition %}partition='{{ partition }}',{% endif %}
        {% if qos %}qos='{{ qos }}',{% endif %}
        {% if job_name %}job_name='{{ job_name }}',{% endif %}
        {% if time_limit %}time_limit='{{ time_limit }}',{% endif %}
        {% if cpus_per_task %}cpus_per_task={{ cpus_per_task }},{% endif %}
        {% if mem %}mem='{{ mem }}',{% endif %}
        {% if extra_sbatch_args %}extra_sbatch_args='{{ extra_sbatch_args }}',{% endif %}
        poll_interval=30,
    )
    {% endif %}

    {# Set up dependencies #}
    {% set prev = None %}
    {% if download %}
        {% set prev = 'git_clone' %}
    {% endif %}
    {% if transfer %}
        {% if prev %}
    {{ prev }} >> transfer_to_gpfs
        {% endif %}
        {% set prev = 'transfer_to_gpfs' %}
    {% endif %}
    {% if ssh_conn_id %}
        {% if prev %}
    {{ prev }} >> slurm_submit
        {% endif %}
    {% endif %}
